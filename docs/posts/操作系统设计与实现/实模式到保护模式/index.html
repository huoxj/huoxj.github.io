<!DOCTYPE html>
<html lang="cn">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width,minimum-scale=1">
  <meta name="generator" content="Hugo 0.135.0">

  <title>实模式到保护模式 | Runz&#39;s Blog</title>
  <meta name="description"
        content="">

  
  <meta name="robots" content="noindex, nofollow">
  

  

  
  
  
  <link href="/output/css/main.5bd88448bb2283387efc5607182f861c30204235e471eaa05d2911cd95a93170.css" integrity="sha256-W9iESLsigzh&#43;/FYHGC&#43;GHDAgQjXkceqgXSkRzZWpMXA=" rel="stylesheet" crossorigin="anonymous">
    
  <link rel="stylesheet" href="https://rsms.me/inter/inter.css"><meta property="og:url" content="https://huoxj.github.io/posts/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/%E5%AE%9E%E6%A8%A1%E5%BC%8F%E5%88%B0%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/">
  <meta property="og:site_name" content="Runz&#39;s Blog">
  <meta property="og:title" content="实模式到保护模式">
  <meta property="og:description" content="开机-实模式到保护模式 实模式到保护模式这个过程已经接触过很多次了。最早从软院OS实验的例行检查里背过相关内容，然后便不无意外地忘掉了。这次在OSDI课上又涉及到了这部分内容，趁此机会重温一下并写一个通俗易懂的笔记，以便以后查阅(可能并不会)。
实模式 摆龙门阵 Intel为了兼容8086搞出来的玩意，在8、90年代很有用，但是对于现在来说还是太old-school了，所以新的UEFI启动方式已经渐渐取代了原来的BIOS，尽管我的装机U盘上的PE系统还保留了Legacy启动。
这里还有个UEFI和BIOS的区别 - 知乎专栏，有时间再看。
我想，实模式作为入门OS的很大原因在于UEFI比较复杂，大学计算机课程只能以BIOS为框架进行教学，所以绕不开这个实模式到保护模式的转换。并且这个转换的过程能体现操作系统内存虚拟化的很多芝士，比如段页式内存管理。所以这一部分内容的理解还是有助于成为操作系统领域大神的www。
实模式小介绍 摘自课程助教编写的实验文档
在QEMU中，i386为了保持向后兼容性，一开机并不是我们熟悉的保护模式，而是实模式。
实模式简单来说就是一个16位的CPU，和保护模式相比，最主要有三点区别：
一是寄存器
不一样，实模式里只会用我们熟悉的寄存器的低16位，所以名字就少了前缀“E”，具体地有：
通用寄存器（16 位）：AX，BX，CX，DX，SP，BP，DI，SI 段寄存器（16 位）：CS，DS，SS，ES 状态和控制寄存器（16 位）： FLAGS，IP 二是寻址方式不一样，在实模式里，虽然有段寄存器，但没有保护模式里的段表，更没有页表，物理地址就是 (段寄存器«4) &#43; 偏移地址 。段寄存器16位，偏移地址也是16位，所以寻址空间就是2^20=1MiB。
三是中断处理不一样，不过我们现在也不关心这个东西，有兴趣的话可以去搜索一下实模式的中断向量表，现在只需要大概知道中断都是由BIOS代办的就行了。
BIOS执行过程以及两个模式 启动的第一条指令地址是0xffff0。这个地址是BIOS ROM地址的最后，指令跳到ROM稍微靠前的地址[CS:IP] 0f000:E05Bh。这个地址开始执行BIOS POST。
这里会立马发生很重要的一个转换，就是从实模式转成保护模式。
原因是POST需要在保护下执行，否则实模式那点空间不够。
自检完后通过INT 19h开始自举。
自举就是依次把每个磁盘的0扇区加载到0x7c00然后看是不是MBR，即看扇区尾巴是不是0x55和0xaa，是的话自举滴任务就完成辣！
其实还没有，自举谢幕前还要进行重要的一步，就是转换回实模式。
原因是要向后提供兼容。不是i386之前的架构的请自觉转到保护模式。
总结为如下图：
实模式到保护模式 这部分是写本文最主要的目的，所以单独拉一个标题来写。
实模式到保护模式主要是两步：设置段表GDT，再将CR0寄存器最低位置1。
现在先只涉及GDT，LDT不管。
保护模式的寻址怎么实现 保护模式比实模式牛的地方之一就是实现了段式内存管理。我们都知道段式内存管理本质就是个二维寻址。
保护模式下的寻址方式如下：
$$逻辑地址 = 段选择子_{16bits} \implies 段基址_{32bits} &#43; 段内偏移_{32bits}$$
段选择子，可以根据字面意思理解记忆，就是记录选择了哪个段的东西。它存放在段寄存器中。
所以怎么从段选择子拿到段基址呢？这就要靠**段表**了。
段表细节见后面小标题，这里只需要知道通过段选择子能找到段表中正确的项，而这个项(有名字，叫段描述符)含有我们想要的很多信息，主要就是段基址。
实验中提到了&#34;扁平模式&#34;，即将段基址全置0，这样偏移量就直接是逻辑地址了。
这样就实现了保护模式的寻址。
段表 段表是个一位线性表。表项是前面说的段描述符，一个段描述符有64位，下面粗略说一下段描述符有哪些信息。
段基址：最主要的信息之一。占32位。 段限长：段的长度，保证内存访问不会越界。也比较重要，占20位。 其他控制位。包括段限长粒度、特权位等。 详细来说，如下
DESCRIPTORS USED FOR APPLICATIONS CODE AND DATA SEGMENTS31 23 15 7 0&#43;-----------------&#43;-&#43;-&#43;-&#43;-&#43;---------&#43;-&#43;-----&#43;-&#43;-----&#43;-&#43;-----------------&#43;| | | | |A| | | | | | | || BASE 31..24 |G|X|O|V| LIMIT |P| DPL |S| TYPE|A| BASE 23..16 | 4| | | | |L| 19..16 | | | | | | ||-----------------&#43;-&#43;-&#43;-&#43;-&#43;---------&#43;-&#43;-----&#43;-&#43;-----&#43;-&#43;-----------------|| | || SEGMENT BASE 15..0 | SEGMENT LIMIT 15..0 | 0| | |&#43;-----------------------------------&#43;-----------------------------------&#43;A - ACCESSEDAVL - AVAILABLE FOR USE BY SYSTEMS PROGRAMMERSDPL - DESCRIPTOR PRIVILEGE LEVELG - GRANULARITYP - SEGMENT PRESENT 具体大致看一下就行了，毕竟真要用到也不会有人记得清的。">
  <meta property="og:locale" content="cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-09-04T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-09-04T00:00:00+00:00">

  <meta itemprop="name" content="实模式到保护模式">
  <meta itemprop="description" content="开机-实模式到保护模式 实模式到保护模式这个过程已经接触过很多次了。最早从软院OS实验的例行检查里背过相关内容，然后便不无意外地忘掉了。这次在OSDI课上又涉及到了这部分内容，趁此机会重温一下并写一个通俗易懂的笔记，以便以后查阅(可能并不会)。
实模式 摆龙门阵 Intel为了兼容8086搞出来的玩意，在8、90年代很有用，但是对于现在来说还是太old-school了，所以新的UEFI启动方式已经渐渐取代了原来的BIOS，尽管我的装机U盘上的PE系统还保留了Legacy启动。
这里还有个UEFI和BIOS的区别 - 知乎专栏，有时间再看。
我想，实模式作为入门OS的很大原因在于UEFI比较复杂，大学计算机课程只能以BIOS为框架进行教学，所以绕不开这个实模式到保护模式的转换。并且这个转换的过程能体现操作系统内存虚拟化的很多芝士，比如段页式内存管理。所以这一部分内容的理解还是有助于成为操作系统领域大神的www。
实模式小介绍 摘自课程助教编写的实验文档
在QEMU中，i386为了保持向后兼容性，一开机并不是我们熟悉的保护模式，而是实模式。
实模式简单来说就是一个16位的CPU，和保护模式相比，最主要有三点区别：
一是寄存器
不一样，实模式里只会用我们熟悉的寄存器的低16位，所以名字就少了前缀“E”，具体地有：
通用寄存器（16 位）：AX，BX，CX，DX，SP，BP，DI，SI 段寄存器（16 位）：CS，DS，SS，ES 状态和控制寄存器（16 位）： FLAGS，IP 二是寻址方式不一样，在实模式里，虽然有段寄存器，但没有保护模式里的段表，更没有页表，物理地址就是 (段寄存器«4) &#43; 偏移地址 。段寄存器16位，偏移地址也是16位，所以寻址空间就是2^20=1MiB。
三是中断处理不一样，不过我们现在也不关心这个东西，有兴趣的话可以去搜索一下实模式的中断向量表，现在只需要大概知道中断都是由BIOS代办的就行了。
BIOS执行过程以及两个模式 启动的第一条指令地址是0xffff0。这个地址是BIOS ROM地址的最后，指令跳到ROM稍微靠前的地址[CS:IP] 0f000:E05Bh。这个地址开始执行BIOS POST。
这里会立马发生很重要的一个转换，就是从实模式转成保护模式。
原因是POST需要在保护下执行，否则实模式那点空间不够。
自检完后通过INT 19h开始自举。
自举就是依次把每个磁盘的0扇区加载到0x7c00然后看是不是MBR，即看扇区尾巴是不是0x55和0xaa，是的话自举滴任务就完成辣！
其实还没有，自举谢幕前还要进行重要的一步，就是转换回实模式。
原因是要向后提供兼容。不是i386之前的架构的请自觉转到保护模式。
总结为如下图：
实模式到保护模式 这部分是写本文最主要的目的，所以单独拉一个标题来写。
实模式到保护模式主要是两步：设置段表GDT，再将CR0寄存器最低位置1。
现在先只涉及GDT，LDT不管。
保护模式的寻址怎么实现 保护模式比实模式牛的地方之一就是实现了段式内存管理。我们都知道段式内存管理本质就是个二维寻址。
保护模式下的寻址方式如下：
$$逻辑地址 = 段选择子_{16bits} \implies 段基址_{32bits} &#43; 段内偏移_{32bits}$$
段选择子，可以根据字面意思理解记忆，就是记录选择了哪个段的东西。它存放在段寄存器中。
所以怎么从段选择子拿到段基址呢？这就要靠**段表**了。
段表细节见后面小标题，这里只需要知道通过段选择子能找到段表中正确的项，而这个项(有名字，叫段描述符)含有我们想要的很多信息，主要就是段基址。
实验中提到了&#34;扁平模式&#34;，即将段基址全置0，这样偏移量就直接是逻辑地址了。
这样就实现了保护模式的寻址。
段表 段表是个一位线性表。表项是前面说的段描述符，一个段描述符有64位，下面粗略说一下段描述符有哪些信息。
段基址：最主要的信息之一。占32位。 段限长：段的长度，保证内存访问不会越界。也比较重要，占20位。 其他控制位。包括段限长粒度、特权位等。 详细来说，如下
DESCRIPTORS USED FOR APPLICATIONS CODE AND DATA SEGMENTS31 23 15 7 0&#43;-----------------&#43;-&#43;-&#43;-&#43;-&#43;---------&#43;-&#43;-----&#43;-&#43;-----&#43;-&#43;-----------------&#43;| | | | |A| | | | | | | || BASE 31..24 |G|X|O|V| LIMIT |P| DPL |S| TYPE|A| BASE 23..16 | 4| | | | |L| 19..16 | | | | | | ||-----------------&#43;-&#43;-&#43;-&#43;-&#43;---------&#43;-&#43;-----&#43;-&#43;-----&#43;-&#43;-----------------|| | || SEGMENT BASE 15..0 | SEGMENT LIMIT 15..0 | 0| | |&#43;-----------------------------------&#43;-----------------------------------&#43;A - ACCESSEDAVL - AVAILABLE FOR USE BY SYSTEMS PROGRAMMERSDPL - DESCRIPTOR PRIVILEGE LEVELG - GRANULARITYP - SEGMENT PRESENT 具体大致看一下就行了，毕竟真要用到也不会有人记得清的。">
  <meta itemprop="datePublished" content="2024-09-04T00:00:00+00:00">
  <meta itemprop="dateModified" content="2024-09-04T00:00:00+00:00">
  <meta itemprop="wordCount" content="216">
  <meta itemprop="keywords" content="操作系统设计与实现">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="实模式到保护模式">
  <meta name="twitter:description" content="开机-实模式到保护模式 实模式到保护模式这个过程已经接触过很多次了。最早从软院OS实验的例行检查里背过相关内容，然后便不无意外地忘掉了。这次在OSDI课上又涉及到了这部分内容，趁此机会重温一下并写一个通俗易懂的笔记，以便以后查阅(可能并不会)。
实模式 摆龙门阵 Intel为了兼容8086搞出来的玩意，在8、90年代很有用，但是对于现在来说还是太old-school了，所以新的UEFI启动方式已经渐渐取代了原来的BIOS，尽管我的装机U盘上的PE系统还保留了Legacy启动。
这里还有个UEFI和BIOS的区别 - 知乎专栏，有时间再看。
我想，实模式作为入门OS的很大原因在于UEFI比较复杂，大学计算机课程只能以BIOS为框架进行教学，所以绕不开这个实模式到保护模式的转换。并且这个转换的过程能体现操作系统内存虚拟化的很多芝士，比如段页式内存管理。所以这一部分内容的理解还是有助于成为操作系统领域大神的www。
实模式小介绍 摘自课程助教编写的实验文档
在QEMU中，i386为了保持向后兼容性，一开机并不是我们熟悉的保护模式，而是实模式。
实模式简单来说就是一个16位的CPU，和保护模式相比，最主要有三点区别：
一是寄存器
不一样，实模式里只会用我们熟悉的寄存器的低16位，所以名字就少了前缀“E”，具体地有：
通用寄存器（16 位）：AX，BX，CX，DX，SP，BP，DI，SI 段寄存器（16 位）：CS，DS，SS，ES 状态和控制寄存器（16 位）： FLAGS，IP 二是寻址方式不一样，在实模式里，虽然有段寄存器，但没有保护模式里的段表，更没有页表，物理地址就是 (段寄存器«4) &#43; 偏移地址 。段寄存器16位，偏移地址也是16位，所以寻址空间就是2^20=1MiB。
三是中断处理不一样，不过我们现在也不关心这个东西，有兴趣的话可以去搜索一下实模式的中断向量表，现在只需要大概知道中断都是由BIOS代办的就行了。
BIOS执行过程以及两个模式 启动的第一条指令地址是0xffff0。这个地址是BIOS ROM地址的最后，指令跳到ROM稍微靠前的地址[CS:IP] 0f000:E05Bh。这个地址开始执行BIOS POST。
这里会立马发生很重要的一个转换，就是从实模式转成保护模式。
原因是POST需要在保护下执行，否则实模式那点空间不够。
自检完后通过INT 19h开始自举。
自举就是依次把每个磁盘的0扇区加载到0x7c00然后看是不是MBR，即看扇区尾巴是不是0x55和0xaa，是的话自举滴任务就完成辣！
其实还没有，自举谢幕前还要进行重要的一步，就是转换回实模式。
原因是要向后提供兼容。不是i386之前的架构的请自觉转到保护模式。
总结为如下图：
实模式到保护模式 这部分是写本文最主要的目的，所以单独拉一个标题来写。
实模式到保护模式主要是两步：设置段表GDT，再将CR0寄存器最低位置1。
现在先只涉及GDT，LDT不管。
保护模式的寻址怎么实现 保护模式比实模式牛的地方之一就是实现了段式内存管理。我们都知道段式内存管理本质就是个二维寻址。
保护模式下的寻址方式如下：
$$逻辑地址 = 段选择子_{16bits} \implies 段基址_{32bits} &#43; 段内偏移_{32bits}$$
段选择子，可以根据字面意思理解记忆，就是记录选择了哪个段的东西。它存放在段寄存器中。
所以怎么从段选择子拿到段基址呢？这就要靠**段表**了。
段表细节见后面小标题，这里只需要知道通过段选择子能找到段表中正确的项，而这个项(有名字，叫段描述符)含有我们想要的很多信息，主要就是段基址。
实验中提到了&#34;扁平模式&#34;，即将段基址全置0，这样偏移量就直接是逻辑地址了。
这样就实现了保护模式的寻址。
段表 段表是个一位线性表。表项是前面说的段描述符，一个段描述符有64位，下面粗略说一下段描述符有哪些信息。
段基址：最主要的信息之一。占32位。 段限长：段的长度，保证内存访问不会越界。也比较重要，占20位。 其他控制位。包括段限长粒度、特权位等。 详细来说，如下
DESCRIPTORS USED FOR APPLICATIONS CODE AND DATA SEGMENTS31 23 15 7 0&#43;-----------------&#43;-&#43;-&#43;-&#43;-&#43;---------&#43;-&#43;-----&#43;-&#43;-----&#43;-&#43;-----------------&#43;| | | | |A| | | | | | | || BASE 31..24 |G|X|O|V| LIMIT |P| DPL |S| TYPE|A| BASE 23..16 | 4| | | | |L| 19..16 | | | | | | ||-----------------&#43;-&#43;-&#43;-&#43;-&#43;---------&#43;-&#43;-----&#43;-&#43;-----&#43;-&#43;-----------------|| | || SEGMENT BASE 15..0 | SEGMENT LIMIT 15..0 | 0| | |&#43;-----------------------------------&#43;-----------------------------------&#43;A - ACCESSEDAVL - AVAILABLE FOR USE BY SYSTEMS PROGRAMMERSDPL - DESCRIPTOR PRIVILEGE LEVELG - GRANULARITYP - SEGMENT PRESENT 具体大致看一下就行了，毕竟真要用到也不会有人记得清的。">


  
</head>

<body class="bg-nord0 font-sans text-nord6 subpixel-antialiased flex flex-col h-screen justify-between tracking-wide">
  <header class="bg-nord1 py-3">
    <div class="container flex justify-between items-center flex-wrap">
  <div class="text-lg font-bold">
    <a href="/">
      
      Runz&#39;s Blog
      
    </a>
  </div>
  <div class="flex items-center flex-wrap">
    

    
    <ul class="flex items-center flex-wrap">
      
      <li class="ml-4">
        <a class="hover:text-white" href="/" title="Home page">Home</a>
      </li>
      
      <li class="ml-4">
        <a class="hover:text-white" href="/posts/" title="Posts page">Posts</a>
      </li>
      
      <li class="ml-4">
        <a class="hover:text-white" href="/series/" title="Series page">Series</a>
      </li>
      
      <li class="ml-4">
        <a class="hover:text-white" href="/about/" title="About page">About</a>
      </li>
      
    </ul>
    
  </div>
</div>

  </header>
  
  <main class="container mb-auto mt-20">
  
  <article>
    <header class="text-center py-20">
      <h1 class="text-5xl pb-2">实模式到保护模式</h1>

      <div class="flex place-content-center">
        

        <time datetime="2024-09-04T00:00:00Z">
          September 4, 2024
        </time>
      </div>
    </header>

    <section class="bg-nord1 rounded-lg p-32 shadow">
      <h1 id="开机-实模式到保护模式">开机-实模式到保护模式</h1>
<p>实模式到保护模式这个过程已经接触过很多次了。最早从软院OS实验的例行检查里背过相关内容，然后便不无意外地忘掉了。这次在OSDI课上又涉及到了这部分内容，趁此机会重温一下并写一个通俗易懂的笔记，以便以后查阅(可能并不会)。</p>
<h2 id="实模式">实模式</h2>
<h3 id="摆龙门阵">摆龙门阵</h3>
<p>Intel为了兼容8086搞出来的玩意，在8、90年代很有用，但是对于现在来说还是太old-school了，所以新的<a href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/bringup/boot-and-uefi">UEFI启动</a>方式已经渐渐取代了原来的BIOS，尽管我的装机U盘上的PE系统还保留了<code>Legacy</code>启动。</p>
<p>这里还有个<a href="https://zhuanlan.zhihu.com/p/436122944">UEFI和BIOS的区别 - 知乎</a>专栏，有时间再看。</p>
<p>我想，实模式作为入门OS的很大原因在于UEFI比较复杂，大学计算机课程只能以BIOS为框架进行教学，所以绕不开这个实模式到保护模式的转换。并且这个转换的过程能体现操作系统内存虚拟化的很多芝士，比如段页式内存管理。所以这一部分内容的理解还是有助于成为操作系统领域大神的www。</p>
<h3 id="实模式小介绍">实模式小介绍</h3>
<blockquote>
<p>摘自课程助教编写的实验文档</p>
</blockquote>
<p>在QEMU中，<code>i386</code>为了保持向后兼容性，一开机并不是我们熟悉的<code>保护模式</code>，而是<code>实模式</code>。</p>
<p>实模式简单来说就是一个16位的CPU，和保护模式相比，最主要有三点区别：</p>
<ul>
<li>
<p>一是<strong>寄存器</strong></p>
<p>不一样，实模式里只会用我们熟悉的寄存器的低16位，所以名字就少了前缀“E”，具体地有：</p>
<ul>
<li>通用寄存器（16 位）：AX，BX，CX，DX，SP，BP，DI，SI</li>
<li>段寄存器（16 位）：CS，DS，SS，ES</li>
<li>状态和控制寄存器（16 位）： FLAGS，IP</li>
</ul>
</li>
<li>
<p>二是<strong>寻址方式</strong>不一样，在实模式里，虽然有段寄存器，但没有保护模式里的段表，更没有页表，物理地址就是 <strong>(段寄存器&laquo;4) + 偏移地址</strong> 。段寄存器16位，偏移地址也是16位，所以寻址空间就是2^20=1MiB。</p>
</li>
<li>
<p>三是<strong>中断处理</strong>不一样，不过我们现在也不关心这个东西，有兴趣的话可以去搜索一下实模式的中断向量表，现在只需要大概知道中断都是由BIOS代办的就行了。</p>
</li>
</ul>
<h2 id="bios执行过程以及两个模式">BIOS执行过程以及两个模式</h2>
<p>启动的第一条指令地址是<code>0xffff0</code>。这个地址是BIOS ROM地址的最后，指令跳到ROM稍微靠前的地址<code>[CS:IP] 0f000:E05Bh</code>。这个地址开始执行BIOS POST。</p>
<p>这里会立马发生很重要的一个<strong>转换</strong>，就是从实模式转成保护模式。</p>
<p>原因是POST需要在保护下执行，否则实模式那点空间不够。</p>
<p>自检完后通过<code>INT 19h</code>开始自举。</p>
<p>自举就是依次把每个磁盘的0扇区加载到<code>0x7c00</code>然后看是不是MBR，即看扇区尾巴是不是<code>0x55</code>和<code>0xaa</code>，是的话自举滴任务就完成辣！</p>
<p>其实还没有，自举谢幕前还要进行重要的一步，就是<strong>转换</strong>回实模式。</p>
<p>原因是要向后提供兼容。不是i386之前的架构的请自觉转到保护模式。</p>
<p>总结为如下图：</p>
<p><img src="https://runzblog.oss-cn-hangzhou.aliyuncs.com/postimg/202409271713413.png" alt="image-20240904112540022"></p>
<h2 id="实模式到保护模式">实模式到保护模式</h2>
<p>这部分是写本文最主要的目的，所以单独拉一个标题来写。</p>
<p>实模式到保护模式主要是两步：设置段表GDT，再将CR0寄存器最低位置1。</p>
<p>现在先只涉及GDT，LDT不管。</p>
<h3 id="保护模式的寻址怎么实现">保护模式的寻址怎么实现</h3>
<p>保护模式比实模式牛的地方之一就是实现了段式内存管理。我们都知道段式内存管理本质就是个二维寻址。</p>
<p>保护模式下的<strong>寻址方式</strong>如下：</p>
<p>$$逻辑地址 = 段选择子_{16bits} \implies 段基址_{32bits} + 段内偏移_{32bits}$$</p>
<p><code>段选择子</code>，可以根据字面意思理解记忆，就是记录选择了哪个段的东西。它存放在<code>段寄存器</code>中。</p>
<p>所以怎么从<code>段选择子</code>拿到<code>段基址</code>呢？这就要靠**<code>段表</code>**了。</p>
<p>段表细节见后面小标题，这里只需要知道通过<code>段选择子</code>能找到段表中正确的项，而这个项(有名字，叫<code>段描述符</code>)含有我们想要的很多信息，主要就是<code>段基址</code>。</p>
<blockquote>
<p>实验中提到了&quot;扁平模式&quot;，即将段基址全置0，这样偏移量就直接是逻辑地址了。</p>
</blockquote>
<p>这样就实现了保护模式的寻址。</p>
<h3 id="段表">段表</h3>
<p><code>段表</code>是个一位线性表。表项是前面说的<code>段描述符</code>，一个<code>段描述符</code>有64位，下面粗略说一下段描述符有哪些信息。</p>
<ul>
<li>段基址：最主要的信息之一。占32位。</li>
<li>段限长：段的长度，保证内存访问不会越界。也比较重要，占20位。</li>
<li>其他控制位。包括段限长粒度、特权位等。</li>
</ul>
<p>详细来说，如下</p>
<pre tabindex="0"><code>DESCRIPTORS USED FOR APPLICATIONS CODE AND DATA SEGMENTS

  31                23                15                7               0
 +-----------------+-+-+-+-+---------+-+-----+-+-----+-+-----------------+
 |                 | | | |A|         | |     | |     | |                 |
 |   BASE 31..24   |G|X|O|V| LIMIT   |P| DPL |S| TYPE|A|  BASE 23..16    | 4
 |                 | | | |L| 19..16  | |     | |     | |                 |
 |-----------------+-+-+-+-+---------+-+-----+-+-----+-+-----------------|
 |                                   |                                   |
 |        SEGMENT BASE 15..0         |       SEGMENT LIMIT 15..0         | 0
 |                                   |                                   |
 +-----------------------------------+-----------------------------------+

           A      - ACCESSED
           AVL    - AVAILABLE FOR USE BY SYSTEMS PROGRAMMERS
           DPL    - DESCRIPTOR PRIVILEGE LEVEL
           G      - GRANULARITY
           P      - SEGMENT PRESENT
</code></pre><p>具体大致看一下就行了，毕竟真要用到也不会有人记得清的。</p>
<p>另外，这个<code>段表</code>的访问也大有学问。<code>段表</code>的基址和长度放在一个叫<code>GDTR</code>的寄存器里。</p>
<pre tabindex="0"><code>                   GDT REGISTER
+--------------------------------+---------------+
|            GDT BASE  	         |   GDT LIMIT   |
+--------------------------------+---------------+
 47                               15            0
</code></pre><h3 id="段选择子">段选择子</h3>
<blockquote>
<p>以下内容直接copy于实验手册</p>
</blockquote>
<pre tabindex="0"><code> 15                      3   1 0
+-------------------------+-+---+
|                         |T|   |
|          INDEX          | |RPL|
|                         |I|   |
+-------------------------+-+---+
TI - TABLE INDICATOR, 0 = GDT, 1 = LDT
RPL - REQUESTOR&#39;S PRIVILEGE LEVEL
</code></pre><p><code>TI</code>位表示该段选择子为全局段（查GDT）还是局部段（查LDT），实验中只会用到前者，<code>RPL</code>表示该段选择子的特权等级，13位<code>Index</code>表示描述符表中的编号（下标）。</p>
<p>结合虚拟地址、段选择符和段表的相关概念，在分段机制中，将虚拟地址转换成线性地址（此时即为物理地址）的过程可描述如下：</p>
<ol>
<li>根据段选择子中的<code>TI</code>位选择GDT或LDT（总是GDT）；</li>
<li>根据段选择子中的<code>index</code>部分到GDT中找到对应位置上的段描述符；</li>
<li>读取段描述符中的<code>base</code>部分，作为32位段基址（总是0），加上32位段内偏移量获取最终的物理地址。</li>
</ol>
<h2 id="总结">总结</h2>
<p>这部分内容最重要的就是为什么需要保护模式、保护模式下的寻址以及段表和段选择子是什么东西。这部分搞懂了基本就没什么问题了。</p>
<p>在OS设计与实现的实验里这部分比较简单，概念搞清楚几行代码就搞定了。</p>

      <ul class="flex list-none mt-20 ml-0 p-0">
  
</ul>

    </section>

    <div class="mt-20">


</div>
  </article>
</main>
  <footer class="container mt-20 py-10 border-t border-nord2">
    <a class="flex items-center flex-wrap" rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">
  <span class="pr-2">
  This work is licensed under CC BY-SA 4.0
  </span>
  
  <svg
   xmlns:dc="http://purl.org/dc/elements/1.1/"
   xmlns:cc="http://creativecommons.org/ns#"
   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
   xmlns:svg="http://www.w3.org/2000/svg"
   xmlns="http://www.w3.org/2000/svg"
   width="22px"
   height="22px"
   viewBox="0 0 268.90738 268.90381"
   version="1.1"
   id="svg8">
  <defs
     id="defs2" />
  <metadata
     id="metadata5">
    <rdf:RDF>
      <cc:Work
         rdf:about="">
        <dc:format>image/svg+xml</dc:format>
        <dc:type
           rdf:resource="http://purl.org/dc/dcmitype/StillImage" />
        <dc:title></dc:title>
      </cc:Work>
    </rdf:RDF>
  </metadata>
  <g
     id="layer1"
     transform="translate(60.21326,50.499404)"
     style="fill:#cccccc">
    <path
       style="fill:#cccccc;stroke-width:0.264583"
       d="m 65.326548,218.13993 c -7.408989,-0.46542 -15.690447,-1.74744 -23.081418,-3.57314 -31.593648,-7.80417 -59.50341,-27.196 -78.984789,-54.879 -12.666454,-17.999 -20.584652,-39.56079 -22.979215,-62.573955 -0.588773,-5.658461 -0.669383,-19.38408 -0.146066,-24.870832 3.119592,-32.707523 16.59157,-61.003391 40.247757,-84.534371 15.2616153,-15.18084 31.549653,-25.40687 50.36784,-31.622169 9.975312,-3.29466 18.955768,-5.117077 30.871725,-6.264843 5.078285,-0.48915 20.860791,-0.402168 26.193748,0.144361 17.33888,1.776911 31.24054,5.591623 45.38445,12.4538 13.95995,6.772926 25.0448,14.737531 36.65278,26.335482 7.30053,7.294229 12.4089,13.497668 17.32958,21.0444786 14.76407,22.6435694 22.22029,49.6275974 21.45807,77.6568024 -0.46871,17.235696 -3.45781,32.378206 -9.34888,47.360416 -7.49661,19.06545 -19.6155,35.81838 -36.29386,50.17195 -27.31891,23.51094 -62.27286,35.37477 -97.671722,33.15102 z m 13.890624,-24.58696 c 15.841765,-0.76807 29.708118,-4.37941 44.185418,-11.50762 19.6139,-9.65733 37.13415,-25.89003 47.43961,-43.95329 6.96873,-12.21469 10.946,-24.7316 12.93683,-40.713641 0.67104,-5.386914 0.66827,-21.171823 -0.005,-26.590624 C 180.44549,43.981851 168.68756,20.905587 149.16032,2.8538209 130.13808,-14.731106 108.6227,-24.146325 83.053631,-26.074732 c -5.193633,-0.391701 -17.404794,-0.161974 -22.092708,0.415627 -10.285637,1.267301 -17.71031,3.035425 -26.228057,6.245993 -29.9817139,11.3009174 -56.047005,39.477533 -65.941823,71.2832 -3.208777,10.314217 -4.489061,18.317852 -4.719883,29.506144 -0.208211,10.092276 0.47345,17.242929 2.4713,25.924058 5.622303,24.43025 19.636401,46.44843 39.7820077,62.5033 18.1256193,14.44505 39.8519053,22.67019 62.7062473,23.73934 2.255572,0.10551 4.279635,0.20867 4.497916,0.22922 0.218281,0.0206 2.778125,-0.0781 5.688541,-0.21918 z M 30.118038,125.15173 C 21.434959,123.79805 14.347465,120.33213 8.6867364,114.6714 1.3325742,107.31724 -2.4067819,96.984367 -2.4067819,84.016961 c 0,-8.085137 1.5872327,-15.633104 4.5106217,-21.449926 C 5.4861963,55.83698 12.3068,49.171317 19.11187,45.945369 c 5.23178,-2.48013 9.591952,-3.455662 16.334628,-3.654661 10.82623,-0.319518 18.524856,1.624447 25.857645,6.529271 3.902054,2.61004 7.896228,6.879878 10.578412,11.308498 l 0.835324,1.379219 -2.703478,1.434338 c -6.151456,3.263673 -15.039649,7.845608 -15.215139,7.843528 -0.103587,-0.0013 -0.605057,-0.80305 -1.11438,-1.781828 -1.356468,-2.606757 -4.590515,-5.79732 -7.14375,-7.047696 -2.685235,-1.315019 -4.460541,-1.74471 -7.22381,-1.748435 -7.952604,-0.01072 -13.378049,3.987215 -15.901505,11.717607 -2.048417,6.275159 -2.048491,17.061121 -1.58e-4,23.178173 2.234617,6.673367 6.42223,10.903017 11.955673,12.075697 3.975534,0.84251 9.523997,0.30321 12.537453,-1.21863 3.04397,-1.53725 5.77738,-4.36532 7.552962,-7.814528 l 0.980212,-1.904137 8.146462,4.074875 c 4.617427,2.30964 8.14646,4.22877 8.14646,4.43012 0,0.19539 -0.850363,1.65353 -1.889696,3.24032 -2.416302,3.68905 -7.205178,8.53786 -10.781707,10.91664 -4.746985,3.15726 -9.846024,5.19842 -15.334575,6.13848 -3.582267,0.61356 -11.020075,0.66931 -14.610865,0.10951 z M 109.37967,125.39 c -9.967707,-1.44914 -16.885196,-4.67736 -22.886456,-10.68056 -6.35757,-6.35962 -9.881743,-14.63917 -10.86812,-25.533104 -0.395735,-4.370652 -0.163393,-10.37091 0.568608,-14.684374 2.778691,-16.374044 13.793641,-28.073013 29.696538,-31.540669 2.35918,-0.514426 3.48834,-0.588761 9.04568,-0.595492 5.08055,-0.0062 6.87894,0.09037 8.99583,0.482862 8.18481,1.517523 14.16373,4.460118 19.41412,9.554876 2.48277,2.409169 4.711,5.220872 6.22954,7.86076 l 0.71355,1.240459 -0.61089,0.379408 c -0.75824,0.470913 -16.82726,8.913629 -16.96531,8.913629 -0.0551,0 -0.71109,-0.999651 -1.45771,-2.221447 -1.98393,-3.246591 -4.06947,-5.213273 -7.0223,-6.622071 -3.00807,-1.435158 -4.28275,-1.741035 -7.23118,-1.735222 -11.53755,0.02276 -17.516019,8.036496 -17.538609,23.509366 -0.01246,8.543372 2.160459,15.372349 6.170589,19.392629 1.76767,1.77214 3.20485,2.68168 5.69886,3.60656 2.412,0.89448 7.50413,1.12157 10.45053,0.46605 4.87189,-1.08389 8.65425,-4.09612 11.21874,-8.934495 0.44034,-0.830776 0.84629,-1.647526 0.90212,-1.815002 0.061,-0.182935 3.42501,1.356098 8.42618,3.854957 4.57858,2.2877 8.36683,4.19831 8.41833,4.24579 0.0515,0.0475 -0.58827,1.13561 -1.42171,2.41805 -6.02946,9.27767 -15.04318,15.5516 -25.79172,17.95213 -1.43309,0.32005 -3.56472,0.465 -7.67292,0.52174 -3.1287,0.0432 -6.04573,0.0266 -6.48229,-0.0368 z"
       id="path76" />
  </g>
</svg>

  <svg
   xmlns:dc="http://purl.org/dc/elements/1.1/"
   xmlns:cc="http://creativecommons.org/ns#"
   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
   xmlns:svg="http://www.w3.org/2000/svg"
   xmlns="http://www.w3.org/2000/svg"
   width="22px"
   height="22px"
   viewBox="0 0 269.00082 268.82538"
   version="1.1"
   id="svg8">
  <defs
     id="defs2" />
  <metadata
     id="metadata5">
    <rdf:RDF>
      <cc:Work
         rdf:about="">
        <dc:format>image/svg+xml</dc:format>
        <dc:type
           rdf:resource="http://purl.org/dc/dcmitype/StillImage" />
        <dc:title></dc:title>
      </cc:Work>
    </rdf:RDF>
  </metadata>
  <g
     id="layer1"
     transform="translate(277.24967,233.43254)"
     style="fill:#cccccc">
    <path
       style="fill:#cccccc;stroke-width:0.264583"
       d="m -149.88812,35.335792 c -9.54812,-0.709586 -13.43497,-1.182581 -19.57917,-2.382625 -25.64662,-5.009092 -49.13885,-17.949542 -68.98407,-37.9991525 -26.5694,-26.8430445 -39.77044,-60.0909305 -38.74258,-97.5763345 0.71419,-26.04584 7.61271,-48.56922 21.27127,-69.44973 11.3033,-17.27992 27.54285,-33.0769 44.37171,-43.16244 17.0419,-10.21323 34.85965,-15.87487 56.23888,-17.87006 4.68105,-0.43685 19.92301,-0.43746 24.87083,-9.9e-4 23.29546,2.05501 43.440152,8.87006 61.515625,20.81106 8.102536,5.35269 13.871899,10.1228 21.576764,17.83965 5.840177,5.84927 9.406276,9.91973 13.50451,15.4145 11.558431,15.49712 19.429002,33.37935 23.095227,52.47322 2.6321011,13.70807 3.2228099,30.196009 1.5972099,44.582293 -3.0618639,27.097449 -13.1312699,50.106479 -30.6840929,70.11458 -3.424504,3.9035244 -11.778649,12.04028701 -15.860452,15.4477524 -22.390327,18.6913166 -45.839771,28.5376896 -74.744791,31.3851616 -2.83124,0.278924 -17.04496,0.55163 -19.44687,0.373115 z m 21.70063,-25.212864 c 24.81471,-3.3936646 44.731952,-13.3669 63.986079,-32.039998 16.741491,-16.236285 26.870384,-35.742616 30.300437,-58.352914 1.089226,-7.179971 1.215977,-9.117986 1.219647,-18.648166 0.0037,-9.58791 -0.126844,-11.56948 -1.22877,-18.65312 -4.1636,-26.76532 -18.047795,-50.14601 -40.571778,-68.32203 -15.945913,-12.86775 -33.076085,-19.981 -54.768745,-22.74252 -5.26911,-0.67077 -21.10365,-0.67315 -26.45833,-0.004 -22.46437,2.80738 -39.58177,10.14944 -56.62083,24.28604 -3.60054,2.98721 -11.05809,10.50314 -14.40229,14.51504 -14.6489,17.57365 -22.53661,35.17132 -25.44148,56.76056 -0.69804,5.18785 -0.97446,17.14732 -0.52615,22.764069 1.50416,18.845411 7.19231,35.336288 17.4749,50.662595 7.2509,10.807551 18.27366,22.280127 28.79336,29.9683603 15.54468,11.3607051 33.48114,18.3126609 51.64853,20.0183427 1.67349,0.15712 3.45942,0.332922 3.96875,0.390675 0.50932,0.05775 4.91463,0.06798 9.78958,0.02273 7.13,-0.06618 9.64069,-0.188553 12.83709,-0.625695 z m -35.39178,-54.867643 -0.0672,-32.609894 -7.74703,-0.07015 -7.74703,-0.07015 0.076,-28.372551 c 0.0875,-32.6577 -0.14933,-29.79422 2.69722,-32.60839 2.77504,-2.74348 -0.18284,-2.53055 34.02447,-2.44937 l 29.76091,0.0706 1.40323,0.77737 c 1.74934,0.9691 3.08144,2.42332 3.98496,4.35026 l 0.69722,1.48696 0.0741,28.37255 0.0741,28.372551 -7.74703,0.07015 -7.74703,0.07015 -0.0672,32.609894 -0.0672,32.609894 h -20.76771 -20.76771 z m 15.54323,-104.048245 c -7.65008,-1.44557 -11.96298,-6.02587 -13.11908,-13.93246 -0.39276,-2.68616 -0.16692,-8.71288 0.41469,-11.0658 1.47824,-5.9803 5.56009,-10.02954 11.65337,-11.56027 2.6088,-0.65538 10.07658,-0.65538 12.68538,0 6.09328,1.53073 10.17513,5.57997 11.65337,11.56027 0.5816,2.35292 0.80745,8.37964 0.41468,11.0658 -1.1831,8.09126 -5.79498,12.79495 -13.78053,14.05486 -2.34301,0.36966 -7.66531,0.304 -9.92188,-0.1224 z"
       id="path162" />
  </g>
</svg>

  <svg
   xmlns:dc="http://purl.org/dc/elements/1.1/"
   xmlns:cc="http://creativecommons.org/ns#"
   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
   xmlns:svg="http://www.w3.org/2000/svg"
   xmlns="http://www.w3.org/2000/svg"
   width="22px"
   height="22px"
   viewBox="0 0 269.69287 269.58087"
   version="1.1"
   id="svg8">
  <defs
     id="defs2" />
  <metadata
     id="metadata5">
    <rdf:RDF>
      <cc:Work
         rdf:about="">
        <dc:format>image/svg+xml</dc:format>
        <dc:type
           rdf:resource="http://purl.org/dc/dcmitype/StillImage" />
        <dc:title></dc:title>
      </cc:Work>
    </rdf:RDF>
  </metadata>
  <g
     id="layer1"
     transform="translate(286.69733,236.4116)"
     style="fill:#cccccc">
    <path
       style="fill:#cccccc;stroke-width:0.264583"
       d="m -161.30298,33.024602 c -33.09048,-2.275337 -61.53656,-15.421337 -85.85925,-39.6787667 -23.13623,-23.0741553 -35.77499,-49.4397933 -39.06422,-81.4916623 -0.56025,-5.459325 -0.63923,-20.351693 -0.13611,-25.664583 2.18732,-23.0978 8.90609,-42.53156 21.11666,-61.07911 13.49749,-20.50234 32.53491,-37.66786 53.33663,-48.09219 12.39138,-6.20967 27.03633,-10.63756 40.949,-12.38089 7.27382,-0.91145 9.8864,-1.05528 19.05,-1.0488 9.76011,0.007 13.94787,0.28323 21.68076,1.43061 26.86175,3.98566 50.854862,15.72696 70.728144,34.61162 12.967099,12.32204 22.118798,24.5019 29.154619,38.80147 4.159358,8.45345 6.787467,15.61203 9.148174,24.91826 5.69259,22.44084 5.585037,48.926081 -0.290168,71.460859 -6.55125,25.127756 -20.299915,46.815711 -41.256953,65.08113634 C -79.294349,14.315783 -97.807112,24.118974 -118.04361,29.174835 c -6.92617,1.730428 -13.31731,2.802282 -21.43125,3.594259 -3.87689,0.378407 -17.68934,0.540094 -21.82812,0.255508 z m 22.35729,-24.9728262 c 19.96596,-2.3357495 37.32835,-9.3539755 53.44583,-21.6038688 8.120806,-6.172117 16.051624,-13.895312 22.071422,-21.493598 12.226789,-15.432854 19.150718,-32.788493 21.500646,-53.893886 0.643308,-5.777741 0.645136,-19.426513 0.0034,-25.135413 -2.266039,-20.15775 -8.649808,-36.85369 -19.929413,-52.12292 -5.168206,-6.9962 -13.213839,-15.47523 -20.338723,-21.4343 -19.497682,-16.30735 -42.912242,-24.60104 -69.453122,-24.60104 -32.33809,0 -59.59141,12.15458 -81.43834,36.32031 -9.54048,10.5531 -16.41628,21.18795 -21.47607,33.2172 -7.9215,18.83276 -10.03228,41.93248 -5.78242,63.281162 1.816,9.122476 4.37185,16.555923 8.68781,25.267707 5.27044,10.638417 11.33919,19.154904 20.21348,28.366296 19.8649,20.6194804 43.26805,31.9241944 70.80483,34.2017461 4.18379,0.346038 17.516,0.1189884 21.69071,-0.3693953 z m -22.35729,-35.9004698 c -18.34463,-2.20681 -34.20388,-12.042565 -43.04677,-26.697208 -4.02402,-6.668696 -7.24408,-16.082073 -8.30325,-24.273363 l -0.17961,-1.389063 h 16.96742 c 13.39715,0 16.96757,0.06959 16.96816,0.330729 5.3e-4,0.181901 0.13207,1.402292 0.29256,2.711979 0.40015,3.26525 1.35402,6.396038 2.81645,9.244108 1.56856,3.054765 4.97243,6.573519 8.00275,8.272845 2.50661,1.405644 6.76894,2.834868 10.18709,3.415885 3.3438,0.56838 11.44552,0.657132 13.7577,0.150715 5.83319,-1.277602 10.18482,-3.720688 14.2658,-8.009094 5.82522,-6.121317 9.47131,-14.391747 11.18792,-25.377583 0.38424,-2.459035 0.47544,-4.666845 0.47544,-11.509376 0,-8.65642 -0.15326,-10.67496 -1.21909,-16.05548 -2.68108,-13.53473 -9.23491,-22.43163 -19.02153,-25.82193 -3.71776,-1.28791 -5.43951,-1.51639 -11.24479,-1.49221 -4.6017,0.0192 -5.70565,0.10962 -8.46667,0.69374 -9.34786,1.97762 -15.22863,6.49582 -18.7228,14.38474 -0.68373,1.54367 -1.81825,5.514 -2.16813,7.5875 l -0.16742,0.99218 h 4.97194 4.97195 l -13.3595,13.36147 -13.3595,13.36146 -13.29791,-13.29532 -13.2979,-13.29531 5.22133,-0.1323 5.22133,-0.13229 0.20605,-1.32291 c 0.44498,-2.85704 1.91678,-8.63464 3.03302,-11.90625 7.3673,-21.59293 25.0818,-35.64201 48.234,-38.2536 3.96056,-0.44676 13.14464,-0.36926 17.59479,0.14847 13.45124,1.56491 24.65795,6.06575 34.13256,13.70832 2.88324,2.32572 8.33265,7.99891 10.668208,11.1063 7.586871,10.09407 11.983783,21.16366 13.949335,35.11863 0.58719,4.16892 0.813215,16.101234 0.391986,20.693895 -1.18622,12.933413 -5.001025,24.079699 -11.629445,33.979505 -6.849974,10.230707 -15.360274,17.842414 -25.643104,22.935492 -6.44958,3.194468 -12.65867,5.129411 -20.23855,6.306942 -4.00262,0.621808 -16.44134,0.904742 -20.15182,0.458382 z"
       id="path344" />
  </g>
</svg>

</a>

  </footer>
</body>

</html>
